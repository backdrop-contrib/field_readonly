<?php

/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

/**
 * Implements hook_entity_info_alter().
 */
function field_readonly_entity_info_alter(&$entity_info) {
  // Add the field_readonly view mode.
  foreach (array_keys($entity_info) as $entity_type) {
    $entity_info[$entity_type]['view modes']['field_readonly'] = array(
      'label' => t('Field Readonly'),
      'custom settings' => FALSE,
    );
  }
}

/**
 * Implements hook_field_attach_form().
 */
function field_readonly_field_attach_form($entity_type, $entity, &$form, &$form_state, $langcode) {
  // Display non-accessible fields as read-only items.
  $entity_id = entity_id($entity_type, $entity);
  if ($entity_id && entity_access('view', $entity_type, $entity)) {
    $build = entity_view($entity_type, array($entity), 'field_readonly');
    $build = $build[$entity_type][$entity_id];

    foreach (element_children($form) as $key) {
      if ($key == 'body' || substr($key, 0, 6) == 'field_') {
        $element = $form[$key];
        if (isset($element['#access']) && !$element['#access'] && isset($build[$key])) {
          $new_key = '_field_readonly__'. $key;
          $form[$new_key] = array_merge($build[$key], array('#weight' => $element['#weight']));
          $attach_css = TRUE;

          // Add support for the Field Group module.
          if (isset($form['#group_children'][$key])) {
            $form['#group_children'][$new_key] = $form['#group_children'][$key];
            $form[$new_key]['#type'] = '_dummy_type';
          }
        }
      }
    }

    if (!empty($attach_css)) {
      $form['#attached']['css'][] = drupal_get_path('module', 'field_readonly') .'/field_readonly.css';
    }
  }
}
